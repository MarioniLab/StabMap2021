---
title: "Neighbourhood uncertainty scores for SCMER and PC selected genes"
author: "Shila Ghazanfar"
date: "02/03/2021"
output:
       html_document:
                     toc: true
                     toc_float:
                           collapsed: false
                           smooth_scroll: false
                     code_folding: hide
                     fig_width: 10
                     fig_height: 8
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      cache = FALSE, cache.lazy = FALSE)
```

# Set up

```{r}
set.seed(2021)

library(MouseGastrulationData)
library(ggplot2)
library(reshape)
library(org.Mm.eg.db)
library(scater)
library(patchwork)
library(gtools)
```

Load functions

```{r}
source("../scripts/StabMap_functions.R")
```

# Load E8.5 data using MouseGastrulationData

```{r}
mt = MouseGastrulationData::AtlasSampleMetadata
samples = mt$sample[mt$stage %in% c("E8.5")]
```

```{r}
SCE <- EmbryoAtlasData(samples = samples)
SCE
SCE <- logNormCounts(SCE)
celltype_colours = MouseGastrulationData::EmbryoCelltypeColours
celltype_colours
```

Randomly subset 5000 cells from this data, for speed reasons

```{r}
cells_thin = sample(colnames(SCE), 5000)
SCE_thin = SCE[,cells_thin]
SCE_thin
```

# Get gene names for SCMER and the PCA method used by Alsu

<!-- Account for gene name difference for Cavin3/Prkcdbp. Then convert to the ENSEMBL -->
<!-- gene IDs. -->

```{r}
geneList_SCMER = sapply(mixedsort(list.files("../data/SCMER/", pattern = "nGenes", full.names = TRUE)), 
                        scan, what = "character", simplify = FALSE)
lapply(geneList_SCMER, function(x) all(x %in% rownames(SCE)))
geneList_PC_ranked_symbols = read.csv("../data/SCMER/selection_spearman.csv", header = TRUE, row.names = 1)[,3]
geneList_PC_ranked = rowData(SCE)$ENSEMBL[match(geneList_PC_ranked_symbols, rowData(SCE)$SYMBOL)]
geneList_PC = lapply(geneList_SCMER, function(x) geneList_PC_ranked[1:length(x)])
```

# Generate similarity for all genes

This will be re-used multiple times. Note this is a dense matrix, 
as output from igraph::similarity.

```{r}
full_sim = generateSimilarity(SCE_thin, batchFactor = SCE_thin$sample)
dim(full_sim)
full_sim[1:5,1:5]
```

# Calculate uncertainty scores for SCMER and PC selected genes

```{r}
plotAdditional = list("celltype", 
                      list(scale_colour_manual(values = celltype_colours),
                           theme(legend.position = "bottom")))
scores_SCMER = lapply(geneList_SCMER, function(geneList) {
  getSubsetUncertainty(SCE_thin,
                       subsetGenes = geneList,
                       full_sim = full_sim,
                       plot = TRUE,
                       plotAdditional = plotAdditional)
})

scores_PC = lapply(geneList_PC, function(geneList) {
  getSubsetUncertainty(SCE_thin,
                       subsetGenes = geneList,
                       full_sim = full_sim,
                       plot = TRUE,
                       plotAdditional = plotAdditional)
})
```

# Some exploration of these scores, for one subset choice

```{r}
scores_df = data.frame(cell = colnames(SCE_thin),
                       score = scores_SCMER[[10]],
                       celltype = SCE_thin$celltype)
```

```{r}
ggplot(scores_df, aes(x = celltype, y = score)) + 
  geom_boxplot(aes(fill = celltype)) +
  theme_classic() +
  scale_fill_manual(values = celltype_colours) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("") +
  theme(legend.position = "bottom") +
  NULL
```

# Estimate scores for the entire dataset

I can also estimate the uncertainty for the full data, given the subset. This
means that I can estimate the uncertainty for all cells, but only pull from the
5000x5000 similarity distribution from the random subset of cells. This is of 
course an estimate, but it's worthwhile knowing one can circumvent needing to 
calculate the similarity across all cells.

```{r}
joint_sample = SCE$sample
names(joint_sample) <- colnames(SCE)

scores_all_SCMER = lapply(geneList_SCMER, function(geneList) {
  getSubsetUncertainty(SCE_thin,
                       querySCE = SCE[, setdiff(colnames(SCE), colnames(SCE_thin))],
                       subsetGenes = geneList,
                       full_sim = full_sim,
                       plot = TRUE,
                       plotAdditional = plotAdditional,
                       jointBatchFactor = joint_sample)
})

scores_all_PC = lapply(geneList_PC, function(geneList) {
  print(length(geneList))
  getSubsetUncertainty(SCE_thin,
                       querySCE = SCE[, setdiff(colnames(SCE), colnames(SCE_thin))],
                       subsetGenes = geneList,
                       full_sim = full_sim,
                       plot = TRUE,
                       plotAdditional = plotAdditional,
                       jointBatchFactor = joint_sample)
})
```

Examine these, first by combining into a single data frame

```{r}
scores_SCMER_df = do.call(rbind, sapply(names(scores_SCMER), function(score_name) {
  scores = scores_all_SCMER[[score_name]]
  data.frame(cell = names(scores),
             score = scores,
             celltype = SCE[,names(scores)]$celltype,
             sample = SCE[,names(scores)]$sample,
             score_n = score_name,
             type = "SCMER")
}, simplify = FALSE))

scores_PC_df = do.call(rbind, sapply(names(scores_PC), function(score_name) {
  scores = scores_all_PC[[score_name]]
  data.frame(cell = names(scores),
             score = scores,
             celltype = SCE[,names(scores)]$celltype,
             sample = SCE[,names(scores)]$sample,
             score_n = score_name,
             type = "PC")
}, simplify = FALSE))

scores_all_df = rbind(scores_SCMER_df, scores_PC_df)
scores_all_df$score_n <- factor(scores_all_df$score_n, levels = mixedsort(unique(scores_all_df$score_n)))

dim(scores_all_df)
head(scores_all_df)

ggplot(scores_all_df, aes(x = interaction(type, score_n), y = score)) + 
  geom_boxplot(aes(fill = type)) + 
  theme_classic() +
  # scale_fill_manual(values = celltype_colours) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("") +
  theme(legend.position = "bottom") +
  NULL

ggplot(subset(scores_all_df, score_n == "../data/SCMER//nGenes_257.txt"),
              aes(x = interaction(type, celltype), y = score)) + 
  geom_boxplot(aes(fill = celltype)) + 
  theme_classic() +
  scale_fill_manual(values = celltype_colours) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("") +
  theme(legend.position = "bottom") +
  NULL
```

# Which genes mark differences between cells with high ambiguity?

Here I perform a clustering of the data using the best SCMER genes, extract 
the clusters with the highest uncertainty values, then re-cluster these cells
using the entire transcriptome. Presumably, the markers for these re-clusters
represent the gene expression differences that are as yet unaccounted for
within the SCMER gene set.

```{r}
SCE_sub <- logNormCounts(SCE[geneList_SCMER[[length(geneList_SCMER)]],])
fit = modelGeneVar(logcounts(SCE_sub))
HVGs = getTopHVGs(fit)
length(HVGs)
SCE_sub <- runPCA(SCE_sub, subset_row = rownames(SCE_sub))
SCE_sub_corrected <- fastMNN(SCE_sub, batch = SCE_sub$sample)
PCs_sub = reducedDim(SCE_sub_corrected, "corrected")
reducedDim(SCE_sub, "UMAP") <- calculateUMAP(t(PCs_sub))

cl = clusterSNNGraph(SCE_sub_corrected, use.dimred = "corrected")
table(cl)

SCE_sub$cluster_SCMER = paste0("SCMER_cluster_", cl)
SCE_sub$score = scores_all_SCMER[[length(scores_all_SCMER)]][colnames(SCE_sub)]

plotUMAP(SCE_sub, colour_by = "cluster_SCMER") + scale_colour_discrete() + ggtitle("Clusters using SCMER genes")
plotUMAP(SCE_sub, colour_by = "score")
plotUMAP(SCE_sub, colour_by = "celltype") + scale_colour_manual(values = celltype_colours)

ggplot(as.data.frame(colData(SCE_sub)), aes(x = cluster_SCMER, y = score)) + 
  geom_boxplot(aes(fill = cluster_SCMER)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  NULL
```

There are clusters that have a high uncertainty value, while others remain 
fairly low. This means that for these clusters, there may be additional genes 
that are needed to better estimate the cell-cell neighbourhoods. 

Re-cluster the cells within these high uncertainty clusters using all genes, 
and extract their marker genes. Visualise these on the full UMAP and examine
what genes they are.

```{r}
clusters_ordered_uncertainty = names(sort(tapply(SCE_sub$score, SCE_sub$cluster_SCMER, median), decreasing = TRUE))
clusters_ordered_uncertainty

minFDRs_list = list()

for (i in 1:5) {
  print(i)
  
  SCE_sub$cluster_SCMER_tmp = SCE_sub$cluster_SCMER == clusters_ordered_uncertainty[i]
  g = plotUMAP(SCE_sub, colour_by = "cluster_SCMER_tmp") +
    scale_colour_manual(values = c("TRUE" = "red", "FALSE" = "grey"), na.value = "grey") +
    ggtitle(paste("Clusters using SCMER genes on SCMER genes UMAP, ",
                  clusters_ordered_uncertainty[i]))
  print(g)
  
  g = plotReducedDim(SCE_sub, dimred = "umap", colour_by = "cluster_SCMER_tmp") +
    scale_colour_manual(values = c("TRUE" = "red", "FALSE" = "grey"), na.value = "grey") +
    ggtitle(paste("Clusters using SCMER genes on full data UMAP, ",
                  clusters_ordered_uncertainty[i])) +
    coord_fixed()
  print(g)
  
  table(SCE_sub$celltype, SCE_sub$cluster_SCMER_tmp)
  
  # cluster within these cells
  SCE_full = SCE[,colnames(SCE_sub)[SCE_sub$cluster_SCMER_tmp]]
  SCE_full <- logNormCounts(SCE_full)
  fit = modelGeneVar(logcounts(SCE_full), block = SCE_full$sample)
  HVGs = getTopHVGs(fit)
  length(HVGs)
  SCE_full <- runPCA(SCE_full, subset_row = HVGs)
  SCE_full_corrected <- fastMNN(SCE_full, batch = SCE_full$sample)
  SCE_full_clusters = clusterSNNGraph(SCE_full_corrected, use.dimred = "corrected")
  table(SCE_full_clusters)
  SCE_full$full_cluster = SCE_full_clusters
  
  full_cluster_markers_array = getMarkerArray(SCE_full, "full_cluster")
  minFDRs = rowMins(full_cluster_markers_array[,,"FDR"], na.rm = TRUE)
  names(minFDRs) <- dimnames(full_cluster_markers_array)[[1]]
  
  minFDRs_list[[i]] <- minFDRs
  
  sort(minFDRs)[1:5]
  table(minFDRs < 0.01)
  head(minFDRs[minFDRs < 0.01])
  rowData(SCE_full)$SYMBOL[order(minFDRs)[1:5]]
  
  gList = sapply(rowData(SCE_full)$SYMBOL[order(minFDRs)[1:9]], function(gene) {
    plotReducedDim(SCE, dimred = "umap", 
                   colour_by = gene,
                   swap_rownames = "SYMBOL",
                   by_exprs_values = "logcounts") +
      coord_fixed()
  }, simplify = FALSE)
  g = wrap_plots(gList, nrow = 3, ncol = 3)
  print(g)
}
```

```{r}
sessionInfo()
```