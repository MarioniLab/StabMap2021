---
title: "StabMap simulation: PBMC Multiome non-overlapping"
author: "Shila Ghazanfar"
date: "25/05/2021"
output:
       html_document:
                     toc: true
                     toc_float:
                           collapsed: false
                           smooth_scroll: false
                     code_folding: hide
                     fig_width: 10 
                     fig_height: 8
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      cache = FALSE, cache.lazy = FALSE)
```

```{r}
set.seed(2021)
```

Load scripts and packages.

```{r}
library(SingleCellMultiModal)
library(MultiAssayExperiment)
library(UpSetR)
source("../scripts/initialise.R")
```

Load data using SingleCellMultiModal Bioconductor package.

```{r}
mae <- scMultiome("pbmc_10x", mode = "*", dry.run = FALSE, format = "MTX")
```

Perform some exploration of this data.

```{r}
gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}
colors <- gg_color_hue(length(unique(mae$celltype)))
names(colors) <- unique(mae$celltype)

mae

upsetSamples(mae)

head(colData(mae))

dim(experiments(mae)[["rna"]])

names(experiments(mae))

sce.rna <- experiments(mae)[["rna"]]
```

Normalise and select features for RNA modality. Perform PCA and visualise
the RNA modality.

```{r}
sce.rna <- logNormCounts(sce.rna)

decomp <- modelGeneVar(sce.rna)
hvgs <- rownames(decomp)[decomp$mean>0.01 & decomp$p.value <= 0.05]
sce.rna <- sce.rna[hvgs,]

# PCA
sce.rna <- scater::runPCA(sce.rna, ncomponents = 25)

# UMAP
sce.rna <- scater::runUMAP(sce.rna, dimred="PCA", n_neighbors = 25, min_dist = 0.3)
plotUMAP(sce.rna, colour_by="celltype", point_size=0.5, point_alpha=1)
```

Normalise and select features for ATAC modality. Perform PCA and visualise
the ATAC modality. Note these cells are the same as the RNA modality.

```{r}
dim(experiments(mae)[["atac"]])

sce.atac <- experiments(mae)[["atac"]]

sce.atac <- logNormCounts(sce.atac)

decomp <- modelGeneVar(sce.atac)
hvgs <- rownames(decomp)[decomp$mean>0.25 & decomp$p.value <= 0.05]
sce.atac <- sce.atac[hvgs,]

sce.atac <- scater::runPCA(sce.atac, ncomponents = 25)

# UMAP
sce.atac <- scater::runUMAP(sce.atac, dimred="PCA", n_neighbors = 25, min_dist = 0.3)
plotUMAP(sce.atac, colour_by="celltype", point_size=0.5, point_alpha=1)
```

Split the cells into three groups with ratios provided below, first for RNA 
modality, second for multiome modality, and third for ATAC modality. Using
this simulation, perform StabMap. Note that other techniques such as PCA,
UINMF, or MultiMAP require some further matching of features between the RNA
and ATAC modalities to be able to run.

Assess the quality of the mapping visually.

```{r}
gList = list()

for (probval in c(1)) {
  
  print(probval)
  
  modality = sample(c("RNA", "Multiome", "ATAC"), size = ncol(sce.rna),
                    replace = TRUE,
                    prob = c(probval,1,probval))
  names(modality) <- colnames(sce.rna)
  table(modality)
  
  # multiome RNA
  M_R = assay(sce.rna, "logcounts")[,modality == "Multiome"]
  
  # multiome ATAC
  M_A = assay(sce.atac, "logcounts")[,modality == "Multiome"]
  
  # RNA
  R = assay(sce.rna, "logcounts")[,modality == "RNA"]
  
  # ATAC
  A = assay(sce.atac, "logcounts")[,modality == "ATAC"]
  
  # they dont have any overlapping features
  Reduce(intersect, list(c(rownames(M_R), rownames(M_A)), rownames(R), rownames(A)))
  
  # there should be no overlapping colnames between the data,
  # but colnames should be identical between the two multiome sub matrices
  identical(colnames(M_R), colnames(M_A))
  intersect(colnames(M_R), colnames(R))
  intersect(colnames(M_R), colnames(A))
  intersect(colnames(R), colnames(A))
  
  assay_list = list(RNA = R,
                    ATAC = A,
                    Multiome = rbind(M_R, M_A))
  
  out_joint = stabMapGeneralised(assay_list,
                                 reference_list = c("Multiome"),
                                 projectAll = TRUE,
                                 plot = FALSE)
  
  # out_joint_UMAP = calculateUMAP_rnames(out_joint)
  
  out_joint_corrected = reducedMNN_batchFactor(
    as.matrix(out_joint), batchFactor = modality[rownames(out_joint)])
  out_joint_UMAP_corrected = calculateUMAP_rnames(out_joint_corrected)
  
  
  out_joint_df = data.frame(cell = names(modality),
                            modality = modality,
                            # UMAP1 = out_joint_UMAP[names(modality),1],
                            # UMAP2 = out_joint_UMAP[names(modality),2],
                            celltype = colData(sce.rna)[names(modality),"celltype"],
                            UMAP1_corrected = out_joint_UMAP_corrected[names(modality),1],
                            UMAP2_corrected = out_joint_UMAP_corrected[names(modality),2])
  out_joint_df <- out_joint_df[sample(rownames(out_joint_df)),]
  
  g = ggplot(out_joint_df, aes(x = modality)) + 
    geom_bar(aes(fill = modality)) +
    ylab("Number of cells") +
    theme_classic() +
    ggplot(out_joint_df, aes(x = UMAP1_corrected, y = UMAP2_corrected)) + 
    geom_point(aes(colour = modality)) +
    theme_classic() +
    ggplot(out_joint_df, aes(x = UMAP1_corrected, y = UMAP2_corrected)) + 
    geom_point(aes(colour = celltype)) +
    theme_classic() +
    ggplot(out_joint_df, aes(x = UMAP1_corrected, y = UMAP2_corrected)) + 
    geom_point(aes(colour = celltype)) +
    facet_wrap(~modality) +
    theme_classic() +
    plot_layout(design = c("
                         123
                         444
                         ")) +
    NULL
  
  gList[[probval]] <- g
  
  print(g)
}
```

# Try with MOFA2

the last value of the loop above is the equal thirds split

```{r}
library(data.table)
library(MOFA2)

# example data
# data <- make_example_data(
#   n_views = 2, 
#   n_samples = 200, 
#   n_features = 1000, 
#   n_factors = 10
# )[[1]]

# lapply(data,dim)

# create data.frame from assay_list

data = do.call(rbind,lapply(assay_list, function(x){
  xlong = data.frame(
    sample = rep(colnames(x), times = nrow(x)),
    feature = rep(rownames(x), each = ncol(x)),
    view = "view_0",
    value = c(as.matrix(x))
  )
}))

# edit such that the ATAC features are in their own view
data[data[,"feature"] %in% c(rownames(sce.atac)),"view"] <- "view_1"

MOFAobject <- create_mofa(data)

data_opts <- get_default_data_options(MOFAobject)
head(data_opts)

model_opts <- get_default_model_options(MOFAobject)
head(model_opts)

train_opts <- get_default_training_options(MOFAobject)
head(train_opts)

MOFAobject <- prepare_mofa(
  object = MOFAobject,
  data_options = data_opts,
  model_options = model_opts,
  training_options = train_opts
)

plot_data_overview(MOFAobject)

outfile = file.path(getwd(),"model.hdf5")
MOFAobject.trained <- run_mofa(MOFAobject, outfile, use_basilisk = TRUE)

MOFAobject.trained = load_model(outfile, remove_inactive_factors = FALSE)

plot_data_overview(MOFAobject.trained)
plot_variance_explained(MOFAobject.trained)

factors <- get_factors(MOFAobject.trained, factors = "all")
lapply(factors,dim)

MOFA_embedding = factors[[1]]
MOFA_embedding_umap = calculateUMAP_rnames(MOFA_embedding)

out_joint_df_MOFA = data.frame(cell = names(modality),
                               modality = modality,
                               # UMAP1 = out_joint_UMAP[names(modality),1],
                               # UMAP2 = out_joint_UMAP[names(modality),2],
                               celltype = colData(sce.rna)[names(modality),"celltype"],
                               UMAP1_corrected = MOFA_embedding_umap[names(modality),1],
                               UMAP2_corrected = MOFA_embedding_umap[names(modality),2])
out_joint_df_MOFA <- out_joint_df_MOFA[sample(rownames(out_joint_df_MOFA)),]

g = ggplot(out_joint_df_MOFA, aes(x = modality)) + 
  geom_bar(aes(fill = modality)) +
  ylab("Number of cells") +
  theme_classic() +
  ggplot(out_joint_df_MOFA, aes(x = UMAP1_corrected, y = UMAP2_corrected)) + 
  geom_point(aes(colour = modality)) +
  theme_classic() +
  ggplot(out_joint_df_MOFA, aes(x = UMAP1_corrected, y = UMAP2_corrected)) + 
  geom_point(aes(colour = celltype)) +
  theme_classic() +
  ggplot(out_joint_df_MOFA, aes(x = UMAP1_corrected, y = UMAP2_corrected)) + 
  geom_point(aes(colour = celltype)) +
  facet_wrap(~modality) +
  theme_classic() +
  plot_layout(design = c("
                         123
                         444
                         ")) +
  NULL
g
```


Finish

```{r}
sessionInfo()
```